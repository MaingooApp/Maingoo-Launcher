version: "3.9"

services:
  # ======================
  # Infrastructure
  # ======================
  nats-server:
    image: nats:latest
    container_name: maingoo-nats-prod
    restart: always
    networks:
      - maingoo-net

  # ======================
  # Databases
  # ======================
  pg-auth:
    image: postgres:16
    container_name: pg-auth-prod
    restart: always
    environment:
      POSTGRES_DB: ${AUTH_DB_NAME:-auth_db}
      POSTGRES_USER: ${AUTH_DB_USER}
      POSTGRES_PASSWORD: ${AUTH_DB_PASSWORD}
    volumes:
      - pgdata-auth:/var/lib/postgresql/data
    networks:
      - maingoo-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${AUTH_DB_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5

  pg-analyzer:
    image: postgres:16
    container_name: pg-analyzer-prod
    restart: always
    environment:
      POSTGRES_DB: ${ANALYZER_DB_NAME:-analyzer_db}
      POSTGRES_USER: ${ANALYZER_DB_USER}
      POSTGRES_PASSWORD: ${ANALYZER_DB_PASSWORD}
    volumes:
      - pgdata-analyzer:/var/lib/postgresql/data
    networks:
      - maingoo-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${ANALYZER_DB_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5

  pg-suppliers:
    image: postgres:16
    container_name: pg-suppliers-prod
    restart: always
    environment:
      POSTGRES_DB: ${SUPPLIERS_DB_NAME:-suppliers_db}
      POSTGRES_USER: ${SUPPLIERS_DB_USER}
      POSTGRES_PASSWORD: ${SUPPLIERS_DB_PASSWORD}
    volumes:
      - pgdata-suppliers:/var/lib/postgresql/data
    networks:
      - maingoo-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${SUPPLIERS_DB_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ======================
  # Microservices
  # ======================
  gateway:
    build:
      context: ./services/gateway
      dockerfile: Dockerfile
    image: gcr.io/${GCP_PROJECT_ID}/maingoo-gateway:${IMAGE_TAG:-latest}
    container_name: maingoo-gateway-prod
    restart: always
    ports:
      - "${GATEWAY_PORT:-3000}:3000"
    command: npm run start:prod
    depends_on:
      nats-server:
        condition: service_started
      auth:
        condition: service_started
      documents-analyzer:
        condition: service_started
      suppliers:
        condition: service_started
    env_file:
      - ./services/gateway/.env.prod
    environment:
      - NODE_ENV=production
      - NATS_SERVERS=nats://nats-server:4222
    networks:
      - maingoo-net
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "require('http').get('http://localhost:3000/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  auth:
    build:
      context: ./services/auth
      dockerfile: Dockerfile
    image: gcr.io/${GCP_PROJECT_ID}/maingoo-auth:${IMAGE_TAG:-latest}
    container_name: maingoo-auth-prod
    restart: always
    command: npm run start:prod
    depends_on:
      pg-auth:
        condition: service_healthy
      nats-server:
        condition: service_started
    env_file:
      - ./services/auth/.env.prod
    environment:
      - NODE_ENV=production
      - NATS_SERVERS=nats://nats-server:4222
      - DATABASE_URL=postgres://${AUTH_DB_USER}:${AUTH_DB_PASSWORD}@pg-auth:5432/${AUTH_DB_NAME:-auth_db}
    networks:
      - maingoo-net

  documents-analyzer:
    build:
      context: ./services/documents-analyzer
      dockerfile: Dockerfile
    image: gcr.io/${GCP_PROJECT_ID}/maingoo-documents-analyzer:${IMAGE_TAG:-latest}
    container_name: maingoo-documents-analyzer-prod
    restart: always
    command: npm run start:prod
    depends_on:
      pg-analyzer:
        condition: service_healthy
      nats-server:
        condition: service_started
    env_file:
      - ./services/documents-analyzer/.env.prod
    environment:
      - NODE_ENV=production
      - NATS_SERVERS=nats://nats-server:4222
      - DATABASE_URL=postgresql://${ANALYZER_DB_USER}:${ANALYZER_DB_PASSWORD}@pg-analyzer:5432/${ANALYZER_DB_NAME:-analyzer_db}
    networks:
      - maingoo-net

  suppliers:
    build:
      context: ./services/suppliers
      dockerfile: Dockerfile
    image: gcr.io/${GCP_PROJECT_ID}/maingoo-suppliers:${IMAGE_TAG:-latest}
    container_name: maingoo-suppliers-prod
    restart: always
    command: npm run start:prod
    depends_on:
      pg-suppliers:
        condition: service_healthy
      nats-server:
        condition: service_started
    env_file:
      - ./services/suppliers/.env.prod
    environment:
      - NODE_ENV=production
      - NATS_SERVERS=nats://nats-server:4222
      - DATABASE_URL=postgresql://${SUPPLIERS_DB_USER}:${SUPPLIERS_DB_PASSWORD}@pg-suppliers:5432/${SUPPLIERS_DB_NAME:-suppliers_db}
    networks:
      - maingoo-net

networks:
  maingoo-net:
    name: maingoo-net

volumes:
  pgdata-auth:
  pgdata-analyzer:
  pgdata-suppliers:
